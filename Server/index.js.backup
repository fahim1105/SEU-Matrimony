const express = require('express')
const cors = require('cors')
const app = express()

require('dotenv').config()
const { MongoClient, ServerApiVersion, ObjectId } = require('mongodb');

const port = process.env.PORT || 5000


// Firebase admin SDK
const admin = require("firebase-admin");

const serviceAccount = require("./seu-matrimony.json");

admin.initializeApp({
    credential: admin.credential.cert(serviceAccount)
});

app.use(express.json({ limit: '10mb' }));
app.use(cors({
    origin: ['http://localhost:5173', 'http://localhost:3000', 'http://localhost:5000'],
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization']
}));

// Request logging middleware
app.use((req, res, next) => {
    console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
    next();
});

// MongoDB Connection URI - Use local MongoDB for now
const uri = `mongodb+srv://${process.env.DB_USER}:${process.env.DB_PASS}@cluster0.mcccn4v.mongodb.net/?appName=Cluster0`;

const client = new MongoClient(uri, {
    serverApi: {
        version: ServerApiVersion.v1,
        strict: true,
        deprecationErrors: true,
    }
}); async function run() {
    try {
        // à§§. à¦¸à¦¾à¦°à§à¦­à¦¾à¦°à§‡à¦° à¦¸à¦¾à¦¥à§‡ à¦•à¦¾à¦¨à§‡à¦•à§à¦Ÿ à¦•à¦°à¦¾ (Connect the client to the server)
        await client.connect();

        // à§¨. à¦¡à¦¾à¦Ÿà¦¾à¦¬à§‡à¦¸ à¦à¦¬à¦‚ à¦•à¦¾à¦²à§‡à¦•à¦¶à¦¨ à¦•à¦¾à¦¨à§‡à¦•à¦¶à¦¨
        const db = client.db("seuMatrimonyDB");
        const biodataCollection = db.collection("biodatas");
        const requestCollection = db.collection("requests");
        const usersCollection = db.collection("users");
        const verificationCollection = db.collection("verifications");

        // à§©. à¦•à¦¾à¦¨à§‡à¦•à¦¶à¦¨ à¦•à¦¨à¦«à¦¾à¦°à§à¦® à¦•à¦°à¦¾à¦° à¦œà¦¨à§à¦¯ à¦ªà¦¿à¦‚ (Ping to confirm successful connection)
        await db.admin().ping();

        console.log("-------------------------------------------------");
        console.log(" âœ… Pinged your deployment.");
        console.log(" ðŸš€ You successfully connected to MongoDB!");
        console.log(` ðŸ“¡ Server is live at: http://localhost:${port}`);
        console.log("-------------------------------------------------");

        // --- Middleware: à¦‡à¦‰à¦œà¦¾à¦° à¦­à§‡à¦°à¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨ à¦šà§‡à¦• à¦•à¦°à¦¾ ---
        const checkUserVerification = async (req, res, next) => {
            try {
                const userEmail = req.body.email || req.body.contactEmail || req.params.email || req.query.email;
                if (!userEmail) return res.status(400).json({ success: false, message: 'à¦‡à¦®à§‡à¦‡à¦² à¦ªà§à¦°à¦¯à¦¼à§‹à¦œà¦¨' });

                const user = await usersCollection.findOne({ email: userEmail });
                if (!user) return res.status(404).json({ success: false, message: 'à¦‡à¦‰à¦œà¦¾à¦° à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' });
                if (!user.isEmailVerified) return res.status(403).json({ success: false, message: 'à¦‡à¦®à§‡à¦‡à¦² à¦­à§‡à¦°à¦¿à¦«à¦¾à¦‡ à¦•à¦°à§à¦¨' });
                if (!user.isActive) return res.status(403).json({ success: false, message: 'à¦†à¦ªà¦¨à¦¾à¦° à¦à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦¨à¦¿à¦·à§à¦•à§à¦°à¦¿à¦¯à¦¼' });

                req.user = user;
                next();
            } catch (error) {
                console.error('User verification middleware error:', error);
                res.status(500).json({ success: false, message: 'à¦¸à¦¾à¦°à§à¦­à¦¾à¦° à¦‡à¦¨à§à¦Ÿà¦¾à¦°à¦¨à¦¾à¦² à¦à¦°à¦°' });
            }
        };

        // ======================================================
        // API Endpoints
        // ======================================================

        // à§§. à¦‡à¦‰à¦œà¦¾à¦° à¦°à§‡à¦œà¦¿à¦¸à§à¦Ÿà§à¦°à§‡à¦¶à¦¨
        app.post('/register-user', async (req, res) => {
            try {
                const { email, displayName, uid } = req.body;
                if (!email.endsWith('@seu.edu.bd')) {
                    return res.status(400).json({ success: false, message: 'à¦¶à§à¦§à§à¦®à¦¾à¦¤à§à¦° SEU à¦‡à¦®à§‡à¦‡à¦² à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§à¦¨' });
                }
                const existingUser = await usersCollection.findOne({ email });
                if (existingUser) return res.status(400).json({ success: false, message: 'à¦à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦‡à¦¤à¦¿à¦®à¦§à§à¦¯à§‡ à¦†à¦›à§‡' });

                const newUser = { uid, email, displayName, isEmailVerified: false, isActive: true, role: 'user', createdAt: new Date() };
                const result = await usersCollection.insertOne(newUser);
                res.json({ success: true, userId: result.insertedId });
            } catch (error) {
                res.status(500).json({ success: false, message: error.message });
            }
        });

        // à§¨. à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦¸à§‡à¦­ à¦¬à¦¾ à¦†à¦ªà¦¡à§‡à¦Ÿ (Upsert) - Simplified for debugging
        app.put('/biodata', async (req, res) => {
            try {
                console.log('Biodata request received:', req.body);
                const biodata = req.body;
                
                // Validate required fields
                if (!biodata.contactEmail) {
                    return res.status(400).json({ success: false, message: 'à¦•à¦¨à§à¦Ÿà¦¾à¦•à§à¦Ÿ à¦‡à¦®à§‡à¦‡à¦² à¦ªà§à¦°à¦¯à¦¼à§‹à¦œà¦¨' });
                }

                // Check if user exists and is verified
                const user = await usersCollection.findOne({ email: biodata.contactEmail });
                if (!user) {
                    return res.status(404).json({ success: false, message: 'à¦‡à¦‰à¦œà¦¾à¦° à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' });
                }
                if (!user.isEmailVerified) {
                    return res.status(403).json({ success: false, message: 'à¦ªà§à¦°à¦¥à¦®à§‡ à¦‡à¦®à§‡à¦‡à¦² à¦­à§‡à¦°à¦¿à¦«à¦¾à¦‡ à¦•à¦°à§à¦¨' });
                }
                if (!user.isActive) {
                    return res.status(403).json({ success: false, message: 'à¦†à¦ªà¦¨à¦¾à¦° à¦à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦¨à¦¿à¦·à§à¦•à§à¦°à¦¿à¦¯à¦¼ à¦°à¦¯à¦¼à§‡à¦›à§‡' });
                }
                
                // Generate unique biodata ID if not exists
                const existingBiodata = await biodataCollection.findOne({ contactEmail: biodata.contactEmail });
                if (!existingBiodata) {
                    // Generate unique biodata ID
                    const count = await biodataCollection.countDocuments();
                    biodata.biodataId = `SEU${String(count + 1).padStart(4, '0')}`;
                }
                
                // Add status and timestamps
                biodata.status = 'pending'; // Admin approval required
                biodata.submittedAt = new Date();
                biodata.updatedAt = new Date();

                const query = { contactEmail: biodata.contactEmail };
                const updateDoc = { $set: biodata };
                const result = await biodataCollection.updateOne(query, updateDoc, { upsert: true });
                
                console.log('Biodata save result:', result);
                
                res.json({ 
                    success: true, 
                    message: 'à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ à¦¸à¦¾à¦¬à¦®à¦¿à¦Ÿ à¦¹à¦¯à¦¼à§‡à¦›à§‡à¥¤ à¦à¦¡à¦®à¦¿à¦¨ à¦…à¦¨à§à¦®à§‹à¦¦à¦¨à§‡à¦° à¦…à¦ªà§‡à¦•à§à¦·à¦¾à¦¯à¦¼ à¦°à¦¯à¦¼à§‡à¦›à§‡à¥¤',
                    result 
                });
            } catch (error) {
                console.error('Biodata save error:', error);
                res.status(500).json({ success: false, message: 'à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦¸à§‡à¦­ à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡', error: error.message });
            }
        });

        // à§©. à¦«à¦¿à¦²à§à¦Ÿà¦¾à¦° à¦…à¦¨à§à¦¯à¦¾à§Ÿà§€ à¦¸à¦¬ à¦¬à¦¾à§Ÿà§‹à¦¡à¦¾à¦Ÿà¦¾ à¦†à¦¨à¦¾ (Approved Only)
        app.get('/all-biodata', async (req, res) => {
            const { gender, department, bloodGroup } = req.query;
            let query = { status: 'approved' };
            if (gender) query.gender = gender;
            if (department) query.department = department;
            if (bloodGroup) query.bloodGroup = bloodGroup;

            const result = await biodataCollection.find(query).toArray();
            res.send(result);
        });

        // à§ª. à¦•à¦¾à¦¨à§‡à¦•à¦¶à¦¨ à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦ªà¦¾à¦ à¦¾à¦¨à§‹
        app.post('/send-request', async (req, res) => {
            try {
                console.log('Send request received:', req.body);
                const requestInfo = req.body;
                
                // Validate required fields
                if (!requestInfo.senderEmail || !requestInfo.receiverEmail) {
                    return res.status(400).json({ success: false, message: 'à¦ªà§à¦°à§‡à¦°à¦• à¦à¦¬à¦‚ à¦ªà§à¦°à¦¾à¦ªà¦•à§‡à¦° à¦‡à¦®à§‡à¦‡à¦² à¦ªà§à¦°à¦¯à¦¼à§‹à¦œà¦¨' });
                }

                // Check if sender exists and is verified
                const sender = await usersCollection.findOne({ email: requestInfo.senderEmail });
                if (!sender) {
                    return res.status(404).json({ success: false, message: 'à¦ªà§à¦°à§‡à¦°à¦• à¦‡à¦‰à¦œà¦¾à¦° à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' });
                }
                if (!sender.isEmailVerified) {
                    return res.status(403).json({ success: false, message: 'à¦ªà§à¦°à¦¥à¦®à§‡ à¦‡à¦®à§‡à¦‡à¦² à¦­à§‡à¦°à¦¿à¦«à¦¾à¦‡ à¦•à¦°à§à¦¨' });
                }
                if (!sender.isActive) {
                    return res.status(403).json({ success: false, message: 'à¦†à¦ªà¦¨à¦¾à¦° à¦à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦¨à¦¿à¦·à§à¦•à§à¦°à¦¿à¦¯à¦¼ à¦°à¦¯à¦¼à§‡à¦›à§‡' });
                }

                // Check if receiver exists
                const receiver = await usersCollection.findOne({ email: requestInfo.receiverEmail });
                if (!receiver) {
                    return res.status(404).json({ success: false, message: 'à¦ªà§à¦°à¦¾à¦ªà¦• à¦‡à¦‰à¦œà¦¾à¦° à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' });
                }

                // Check if request already exists
                const existingRequest = await requestCollection.findOne({
                    senderEmail: requestInfo.senderEmail,
                    receiverEmail: requestInfo.receiverEmail
                });
                
                if (existingRequest) {
                    return res.status(400).json({ success: false, message: 'à¦†à¦ªà¦¨à¦¿ à¦‡à¦¤à¦¿à¦®à¦§à§à¦¯à§‡ à¦à¦‡ à¦¬à§à¦¯à¦•à§à¦¤à¦¿à¦° à¦•à¦¾à¦›à§‡ à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦ªà¦¾à¦ à¦¿à¦¯à¦¼à§‡à¦›à§‡à¦¨' });
                }

                // Add timestamp
                requestInfo.sentAt = new Date();
                requestInfo.status = 'pending';
                
                const result = await requestCollection.insertOne(requestInfo);
                console.log('Request saved:', result);
                
                res.json({ success: true, message: 'à¦•à¦¾à¦¨à§‡à¦•à¦¶à¦¨ à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ à¦ªà¦¾à¦ à¦¾à¦¨à§‹ à¦¹à¦¯à¦¼à§‡à¦›à§‡', result });
            } catch (error) {
                console.error('Send request error:', error);
                res.status(500).json({ success: false, message: 'à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦ªà¦¾à¦ à¦¾à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§«. à¦‡à¦®à§‡à¦‡à¦² à¦­à§‡à¦°à¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨ à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¾à¦¸ à¦†à¦ªà¦¡à§‡à¦Ÿ
        app.patch('/verify-email', async (req, res) => {
            try {
                const { email } = req.body;
                const result = await usersCollection.updateOne(
                    { email },
                    { $set: { isEmailVerified: true, verifiedAt: new Date() } }
                );

                if (result.matchedCount === 0) {
                    return res.status(404).json({ success: false, message: 'à¦‡à¦‰à¦œà¦¾à¦° à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' });
                }

                res.json({ success: true, message: 'à¦‡à¦®à§‡à¦‡à¦² à¦­à§‡à¦°à¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨ à¦¸à¦«à¦² à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            } catch (error) {
                console.error('Email verification error:', error);
                res.status(500).json({ success: false, message: 'à¦­à§‡à¦°à¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§¬. à¦‡à¦‰à¦œà¦¾à¦° à¦ªà§à¦°à§‹à¦«à¦¾à¦‡à¦² à¦¤à¦¥à§à¦¯
        app.get('/user/:email', async (req, res) => {
            try {
                const email = req.params.email;
                const user = await usersCollection.findOne({ email });
                
                if (!user) {
                    return res.status(404).json({ success: false, message: 'à¦‡à¦‰à¦œà¦¾à¦° à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' });
                }

                res.json({ success: true, user });
            } catch (error) {
                console.error('Get user error:', error);
                res.status(500).json({ success: false, message: 'à¦‡à¦‰à¦œà¦¾à¦° à¦¤à¦¥à§à¦¯ à¦†à¦¨à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§­. à¦à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦¡à¦¿à¦…à§à¦¯à¦¾à¦•à§à¦Ÿà¦¿à¦­à§‡à¦Ÿ à¦•à¦°à¦¾
        app.patch('/deactivate-account', async (req, res) => {
            try {
                const { email, reason } = req.body;
                
                const result = await usersCollection.updateOne(
                    { email },
                    { 
                        $set: { 
                            isActive: false, 
                            deactivatedAt: new Date(),
                            deactivationReason: reason || 'User requested'
                        } 
                    }
                );

                if (result.matchedCount === 0) {
                    return res.status(404).json({ success: false, message: 'à¦‡à¦‰à¦œà¦¾à¦° à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' });
                }

                res.json({ success: true, message: 'à¦à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ à¦¡à¦¿à¦…à§à¦¯à¦¾à¦•à§à¦Ÿà¦¿à¦­à§‡à¦Ÿ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            } catch (error) {
                console.error('Deactivate account error:', error);
                res.status(500).json({ success: false, message: 'à¦à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦¡à¦¿à¦…à§à¦¯à¦¾à¦•à§à¦Ÿà¦¿à¦­à§‡à¦Ÿ à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§®. à¦à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦°à¦¿à¦…à§à¦¯à¦¾à¦•à§à¦Ÿà¦¿à¦­à§‡à¦Ÿ à¦•à¦°à¦¾
        app.patch('/reactivate-account', async (req, res) => {
            try {
                const { email } = req.body;
                
                const result = await usersCollection.updateOne(
                    { email },
                    { 
                        $set: { 
                            isActive: true, 
                            reactivatedAt: new Date()
                        },
                        $unset: { 
                            deactivatedAt: 1, 
                            deactivationReason: 1 
                        }
                    }
                );

                if (result.matchedCount === 0) {
                    return res.status(404).json({ success: false, message: 'à¦‡à¦‰à¦œà¦¾à¦° à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' });
                }

                res.json({ success: true, message: 'à¦à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ à¦°à¦¿à¦…à§à¦¯à¦¾à¦•à§à¦Ÿà¦¿à¦­à§‡à¦Ÿ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            } catch (error) {
                console.error('Reactivate account error:', error);
                res.status(500).json({ success: false, message: 'à¦à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦°à¦¿à¦…à§à¦¯à¦¾à¦•à§à¦Ÿà¦¿à¦­à§‡à¦Ÿ à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§¯. à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦¦à§‡à¦–à¦¾ (Received Requests)
        app.get('/received-requests/:email', async (req, res) => {
            try {
                const email = req.params.email;
                const query = { receiverEmail: email };
                const result = await requestCollection.find(query).toArray();
                res.json({ success: true, requests: result });
            } catch (error) {
                console.error('Get requests error:', error);
                res.status(500).json({ success: false, message: 'à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦†à¦¨à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§§à§¦. à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦à¦•à§à¦¸à§‡à¦ªà§à¦Ÿ à¦¬à¦¾ à¦°à¦¿à¦œà§‡à¦•à§à¦Ÿ à¦•à¦°à¦¾
        app.patch('/request-status/:id', async (req, res) => {
            try {
                const id = req.params.id;
                const { status } = req.body; // 'accepted' or 'rejected'
                const filter = { _id: new ObjectId(id) };
                const updateDoc = { $set: { status: status, updatedAt: new Date() } };
                const result = await requestCollection.updateOne(filter, updateDoc);
                
                if (result.matchedCount === 0) {
                    return res.status(404).json({ success: false, message: 'à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' });
                }

                res.json({ success: true, message: 'à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¾à¦¸ à¦†à¦ªà¦¡à§‡à¦Ÿ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            } catch (error) {
                console.error('Update request status error:', error);
                res.status(500).json({ success: false, message: 'à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¾à¦¸ à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§§à§§. à¦à¦¡à¦®à¦¿à¦¨ - à¦ªà§‡à¦¨à§à¦¡à¦¿à¦‚ à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦¦à§‡à¦–à¦¾
        app.get('/admin/pending-biodatas', async (req, res) => {
            try {
                const pendingBiodatas = await biodataCollection.find({ status: 'pending' }).toArray();
                res.json({ success: true, biodatas: pendingBiodatas });
            } catch (error) {
                console.error('Get pending biodatas error:', error);
                res.status(500).json({ success: false, message: 'à¦ªà§‡à¦¨à§à¦¡à¦¿à¦‚ à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦†à¦¨à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§§à§¨. à¦à¦¡à¦®à¦¿à¦¨ - à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦…à¦¨à§à¦®à§‹à¦¦à¦¨/à¦ªà§à¦°à¦¤à§à¦¯à¦¾à¦–à§à¦¯à¦¾à¦¨
        app.patch('/admin/biodata-status/:id', async (req, res) => {
            try {
                const id = req.params.id;
                const { status, adminNote } = req.body; // 'approved' or 'rejected'
                
                const updateDoc = { 
                    $set: { 
                        status: status,
                        adminReviewedAt: new Date(),
                        adminNote: adminNote || ''
                    } 
                };
                
                const result = await biodataCollection.updateOne(
                    { _id: new ObjectId(id) }, 
                    updateDoc
                );

                if (result.matchedCount === 0) {
                    return res.status(404).json({ success: false, message: 'à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' });
                }

                const message = status === 'approved' ? 'à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦…à¦¨à§à¦®à§‹à¦¦à¦¿à¦¤ à¦¹à¦¯à¦¼à§‡à¦›à§‡' : 'à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦ªà§à¦°à¦¤à§à¦¯à¦¾à¦–à§à¦¯à¦¾à¦¨ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡';
                res.json({ success: true, message });
            } catch (error) {
                console.error('Update biodata status error:', error);
                res.status(500).json({ success: false, message: 'à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¾à¦¸ à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§§à§ª. à¦‡à¦‰à¦œà¦¾à¦°à§‡à¦° à¦ªà¦¾à¦ à¦¾à¦¨à§‹ à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦¦à§‡à¦–à¦¾ (Sent Requests)
        app.get('/sent-requests/:email', async (req, res) => {
            try {
                const email = req.params.email;
                const query = { senderEmail: email };
                const result = await requestCollection.find(query).toArray();
                res.json({ success: true, requests: result });
            } catch (error) {
                console.error('Get sent requests error:', error);
                res.status(500).json({ success: false, message: 'à¦ªà¦¾à¦ à¦¾à¦¨à§‹ à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦†à¦¨à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§§à§«. à¦‡à¦‰à¦œà¦¾à¦° à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¿à¦¸à§à¦Ÿà¦¿à¦•à§à¦¸ (Real Data)
        app.get('/user-stats/:email', async (req, res) => {
            try {
                const email = req.params.email;
                
                const sentRequests = await requestCollection.countDocuments({ senderEmail: email });
                const receivedRequests = await requestCollection.countDocuments({ receiverEmail: email });
                const acceptedRequests = await requestCollection.countDocuments({ 
                    $or: [
                        { senderEmail: email, status: 'accepted' },
                        { receiverEmail: email, status: 'accepted' }
                    ]
                });
                
                // Profile views (you can implement a views collection later)
                const profileViews = 0; // Placeholder for now
                
                res.json({ 
                    success: true, 
                    stats: {
                        sentRequests,
                        receivedRequests,
                        acceptedRequests,
                        profileViews
                    }
                });
            } catch (error) {
                console.error('Get user stats error:', error);
                res.status(500).json({ success: false, message: 'à¦‡à¦‰à¦œà¦¾à¦° à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¸ à¦†à¦¨à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§§à§¬. à¦‡à¦‰à¦œà¦¾à¦°à§‡à¦° à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¾à¦¸ à¦šà§‡à¦•
        app.get('/biodata-status/:email', async (req, res) => {
            try {
                const email = req.params.email;
                const biodata = await biodataCollection.findOne({ contactEmail: email });
                
                if (!biodata) {
                    return res.json({ 
                        success: true, 
                        hasProfile: false, 
                        status: null 
                    });
                }

                res.json({ 
                    success: true, 
                    hasProfile: true, 
                    status: biodata.status,
                    submittedAt: biodata.submittedAt,
                    updatedAt: biodata.updatedAt
                });
            } catch (error) {
                console.error('Get biodata status error:', error);
                res.status(500).json({ success: false, message: 'à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¾à¦¸ à¦†à¦¨à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });
        // à§§à§­. à¦—à§ƒà¦¹à§€à¦¤ à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦¥à§‡à¦•à§‡ à¦•à¦¥à§‹à¦ªà¦•à¦¥à¦¨ à¦¤à§ˆà¦°à¦¿
        app.get('/accepted-conversations/:email', async (req, res) => {
            try {
                const email = req.params.email;
                
                // Find all accepted requests where user is either sender or receiver
                const acceptedRequests = await requestCollection.find({
                    $or: [
                        { senderEmail: email, status: 'accepted' },
                        { receiverEmail: email, status: 'accepted' }
                    ]
                }).toArray();

                // Create conversation objects with other user info
                const conversations = await Promise.all(
                    acceptedRequests.map(async (request) => {
                        const otherUserEmail = request.senderEmail === email 
                            ? request.receiverEmail 
                            : request.senderEmail;
                        
                        // Get other user's biodata for name
                        const otherUserBiodata = await biodataCollection.findOne({ 
                            contactEmail: otherUserEmail 
                        });
                        
                        return {
                            _id: request._id,
                            otherUser: {
                                email: otherUserEmail,
                                name: otherUserBiodata?.name || 'SEU Member'
                            },
                            lastActivity: request.updatedAt || request.sentAt
                        };
                    })
                );

                res.json({ success: true, conversations });
            } catch (error) {
                console.error('Get conversations error:', error);
                res.status(500).json({ success: false, message: 'à¦•à¦¥à§‹à¦ªà¦•à¦¥à¦¨ à¦†à¦¨à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§§à§®. à¦®à§‡à¦¸à§‡à¦œ à¦ªà¦¾à¦ à¦¾à¦¨à§‹
        app.post('/send-message', async (req, res) => {
            try {
                const messageData = req.body;
                messageData.sentAt = new Date();
                
                // You can create a messages collection for this
                // For now, we'll just return success
                res.json({ success: true, message: 'à¦®à§‡à¦¸à§‡à¦œ à¦ªà¦¾à¦ à¦¾à¦¨à§‹ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            } catch (error) {
                console.error('Send message error:', error);
                res.status(500).json({ success: false, message: 'à¦®à§‡à¦¸à§‡à¦œ à¦ªà¦¾à¦ à¦¾à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§§à§¯. à¦•à¦¥à§‹à¦ªà¦•à¦¥à¦¨à§‡à¦° à¦®à§‡à¦¸à§‡à¦œ à¦†à¦¨à¦¾
        app.get('/messages/:conversationId', async (req, res) => {
            try {
                const conversationId = req.params.conversationId;
                
                // For now, return empty messages array
                // You can implement a messages collection later
                res.json({ success: true, messages: [] });
            } catch (error) {
                console.error('Get messages error:', error);
                res.status(500).json({ success: false, message: 'à¦®à§‡à¦¸à§‡à¦œ à¦†à¦¨à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });
        
        // à§¨à§¦. à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦†à¦‡à¦¡à¦¿ à¦¦à¦¿à¦¯à¦¼à§‡ à¦ªà§à¦°à§‹à¦«à¦¾à¦‡à¦² à¦†à¦¨à¦¾
        app.get('/biodata-by-id/:biodataId', async (req, res) => {
            try {
                const biodataId = req.params.biodataId;
                const biodata = await biodataCollection.findOne({ 
                    biodataId: biodataId, 
                    status: 'approved' 
                });
                
                if (!biodata) {
                    return res.status(404).json({ success: false, message: 'à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' });
                }

                // Remove sensitive information
                const publicBiodata = { ...biodata };
                delete publicBiodata.contactEmail;
                delete publicBiodata.mobile;

                res.json({ success: true, biodata: publicBiodata });
            } catch (error) {
                console.error('Get biodata by ID error:', error);
                res.status(500).json({ success: false, message: 'à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦†à¦¨à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§¨à§§. à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¾à¦¸ à¦šà§‡à¦• à¦•à¦°à¦¾
        app.get('/request-status/:senderEmail/:receiverEmail', async (req, res) => {
            try {
                const { senderEmail, receiverEmail } = req.params;
                
                const request = await requestCollection.findOne({
                    senderEmail: senderEmail,
                    receiverEmail: receiverEmail
                });

                res.json({ 
                    success: true, 
                    hasRequest: !!request,
                    status: request?.status || null,
                    requestId: request?._id || null
                });
            } catch (error) {
                console.error('Check request status error:', error);
                res.status(500).json({ success: false, message: 'à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¾à¦¸ à¦šà§‡à¦• à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§¨à§¨. à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦¬à¦¾à¦¤à¦¿à¦² à¦•à¦°à¦¾
        app.delete('/cancel-request/:requestId', async (req, res) => {
            try {
                const requestId = req.params.requestId;
                
                const result = await requestCollection.deleteOne({ 
                    _id: new ObjectId(requestId),
                    status: 'pending' // Only allow canceling pending requests
                });

                if (result.deletedCount === 0) {
                    return res.status(404).json({ success: false, message: 'à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿ à¦¬à¦¾ à¦‡à¦¤à¦¿à¦®à¦§à§à¦¯à§‡ à¦ªà§à¦°à¦•à§à¦°à¦¿à¦¯à¦¼à¦¾ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
                }

                res.json({ success: true, message: 'à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ à¦¬à¦¾à¦¤à¦¿à¦² à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            } catch (error) {
                console.error('Cancel request error:', error);
                res.status(500).json({ success: false, message: 'à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦¬à¦¾à¦¤à¦¿à¦² à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        // à§¨à§©. à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦†à¦‡à¦¡à¦¿ à¦¦à¦¿à¦¯à¦¼à§‡ à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦ªà¦¾à¦ à¦¾à¦¨à§‹
        app.post('/send-request-by-biodata', async (req, res) => {
            try {
                console.log('Send request by biodata received:', req.body);
                const { senderEmail, receiverBiodataId, status } = req.body;
                
                // Validate required fields
                if (!senderEmail || !receiverBiodataId) {
                    return res.status(400).json({ success: false, message: 'à¦ªà§à¦°à§‡à¦°à¦• à¦‡à¦®à§‡à¦‡à¦² à¦à¦¬à¦‚ à¦ªà§à¦°à¦¾à¦ªà¦•à§‡à¦° à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦†à¦‡à¦¡à¦¿ à¦ªà§à¦°à¦¯à¦¼à§‹à¦œà¦¨' });
                }

                // Get receiver's biodata to find email
                const receiverBiodata = await biodataCollection.findOne({ 
                    biodataId: receiverBiodataId,
                    status: 'approved'
                });
                
                if (!receiverBiodata) {
                    return res.status(404).json({ success: false, message: 'à¦ªà§à¦°à¦¾à¦ªà¦•à§‡à¦° à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' });
                }

                const receiverEmail = receiverBiodata.contactEmail;

                // Check if sender exists and is verified
                const sender = await usersCollection.findOne({ email: senderEmail });
                if (!sender) {
                    return res.status(404).json({ success: false, message: 'à¦ªà§à¦°à§‡à¦°à¦• à¦‡à¦‰à¦œà¦¾à¦° à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' });
                }
                if (!sender.isEmailVerified) {
                    return res.status(403).json({ success: false, message: 'à¦ªà§à¦°à¦¥à¦®à§‡ à¦‡à¦®à§‡à¦‡à¦² à¦­à§‡à¦°à¦¿à¦«à¦¾à¦‡ à¦•à¦°à§à¦¨' });
                }
                if (!sender.isActive) {
                    return res.status(403).json({ success: false, message: 'à¦†à¦ªà¦¨à¦¾à¦° à¦à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦¨à¦¿à¦·à§à¦•à§à¦°à¦¿à¦¯à¦¼ à¦°à¦¯à¦¼à§‡à¦›à§‡' });
                }

                // Check if request already exists
                const existingRequest = await requestCollection.findOne({
                    senderEmail: senderEmail,
                    receiverEmail: receiverEmail
                });
                
                if (existingRequest) {
                    return res.status(400).json({ success: false, message: 'à¦†à¦ªà¦¨à¦¿ à¦‡à¦¤à¦¿à¦®à¦§à§à¦¯à§‡ à¦à¦‡ à¦¬à§à¦¯à¦•à§à¦¤à¦¿à¦° à¦•à¦¾à¦›à§‡ à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦ªà¦¾à¦ à¦¿à¦¯à¦¼à§‡à¦›à§‡à¦¨' });
                }

                // Create request
                const requestData = {
                    senderEmail,
                    receiverEmail,
                    receiverBiodataId,
                    status: 'pending',
                    sentAt: new Date()
                };
                
                const result = await requestCollection.insertOne(requestData);
                console.log('Request saved:', result);
                
                res.json({ success: true, message: 'à¦•à¦¾à¦¨à§‡à¦•à¦¶à¦¨ à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦¸à¦«à¦²à¦­à¦¾à¦¬à§‡ à¦ªà¦¾à¦ à¦¾à¦¨à§‹ à¦¹à¦¯à¦¼à§‡à¦›à§‡', result });
            } catch (error) {
                console.error('Send request by biodata error:', error);
                res.status(500).json({ success: false, message: 'à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦ªà¦¾à¦ à¦¾à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à§¨à§ª. à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦†à¦‡à¦¡à¦¿ à¦¦à¦¿à¦¯à¦¼à§‡ à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¾à¦¸ à¦šà§‡à¦• à¦•à¦°à¦¾
        app.get('/request-status-by-biodata/:senderEmail/:biodataId', async (req, res) => {
            try {
                const { senderEmail, biodataId } = req.params;
                
                // Get receiver's email from biodata
                const receiverBiodata = await biodataCollection.findOne({ 
                    biodataId: biodataId,
                    status: 'approved'
                });
                
                if (!receiverBiodata) {
                    return res.json({ success: true, hasRequest: false, status: null, requestId: null });
                }

                const request = await requestCollection.findOne({
                    senderEmail: senderEmail,
                    receiverEmail: receiverBiodata.contactEmail
                });

                res.json({ 
                    success: true, 
                    hasRequest: !!request,
                    status: request?.status || null,
                    requestId: request?._id || null
                });
            } catch (error) {
                console.error('Check request status by biodata error:', error);
                res.status(500).json({ success: false, message: 'à¦°à¦¿à¦•à§‹à¦¯à¦¼à§‡à¦¸à§à¦Ÿ à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¾à¦¸ à¦šà§‡à¦• à¦•à¦°à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });
        
        app.get('/biodata/:email', async (req, res) => {
            try {
                const email = req.params.email;
                const query = { contactEmail: email };
                const result = await biodataCollection.findOne(query);
                
                if (!result) {
                    return res.status(404).json({ success: false, message: 'à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼à¦¨à¦¿' });
                }

                res.json({ success: true, biodata: result });
            } catch (error) {
                console.error('Get biodata error:', error);
                res.status(500).json({ success: false, message: 'à¦¬à¦¾à¦¯à¦¼à§‹à¦¡à¦¾à¦Ÿà¦¾ à¦†à¦¨à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });
        
        app.get('/admin-stats', async (req, res) => {
            try {
                const totalBiodata = await biodataCollection.countDocuments();
                const approvedBiodata = await biodataCollection.countDocuments({ status: 'approved' });
                const pendingBiodata = await biodataCollection.countDocuments({ status: 'pending' });
                const totalMale = await biodataCollection.countDocuments({ gender: 'Male', status: 'approved' });
                const totalFemale = await biodataCollection.countDocuments({ gender: 'Female', status: 'approved' });
                const totalUsers = await usersCollection.countDocuments();
                const verifiedUsers = await usersCollection.countDocuments({ isEmailVerified: true });
                const activeUsers = await usersCollection.countDocuments({ isActive: true });
                const totalRequests = await requestCollection.countDocuments();
                const acceptedRequests = await requestCollection.countDocuments({ status: 'accepted' });

                res.json({ 
                    success: true,
                    stats: {
                        totalBiodata, 
                        approvedBiodata,
                        pendingBiodata,
                        totalMale, 
                        totalFemale, 
                        totalUsers,
                        verifiedUsers,
                        activeUsers,
                        totalRequests,
                        acceptedRequests
                    }
                });
            } catch (error) {
                console.error('Get admin stats error:', error);
                res.status(500).json({ success: false, message: 'à¦¸à§à¦Ÿà§à¦¯à¦¾à¦Ÿà¦¸ à¦†à¦¨à¦¤à§‡ à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡' });
            }
        });

        // à¦‡à¦¨à¦¡à§‡à¦•à§à¦¸ à¦¤à§ˆà¦°à¦¿ (Performance Optimization)
        try {
            await biodataCollection.createIndex({ contactEmail: 1 });
            await biodataCollection.createIndex({ status: 1 });
            await biodataCollection.createIndex({ gender: 1 });
            await biodataCollection.createIndex({ department: 1 });
            await biodataCollection.createIndex({ district: 1 });
            
            await usersCollection.createIndex({ email: 1 }, { unique: true });
            await usersCollection.createIndex({ uid: 1 }, { unique: true });
            await usersCollection.createIndex({ isEmailVerified: 1 });
            await usersCollection.createIndex({ isActive: 1 });
            
            await requestCollection.createIndex({ senderEmail: 1 });
            await requestCollection.createIndex({ receiverEmail: 1 });
            await requestCollection.createIndex({ status: 1 });
            
            console.log("âœ… Database indexes created successfully!");
        } catch (indexError) {
            console.log("â„¹ï¸ Index creation info:", indexError.message);
        }

        console.log("ðŸŽ‰ Server setup completed successfully!");

    } catch (err) {
        console.error("âŒ MongoDB Connection Error:", err.message);
        console.error("ðŸ”„ Please check your database credentials and connection string");
        process.exit(1);
    }
    // run() à¦à¦° à¦¶à§‡à¦·à§‡ client.close() à¦¦à§‡à¦“à§Ÿà¦¾ à¦¯à¦¾à¦¬à§‡ à¦¨à¦¾, à¦•à¦¾à¦°à¦£ à¦¸à¦¾à¦°à§à¦­à¦¾à¦° à¦¸à¦¬à¦¸à¦®à§Ÿ à¦•à¦¾à¦¨à§‡à¦•à§à¦Ÿà§‡à¦¡ à¦¥à¦¾à¦•à¦¤à§‡ à¦¹à¦¬à§‡à¥¤
}

run().catch(console.dir);

// à¦°à§à¦Ÿ à¦Ÿà§‡à¦¸à§à¦Ÿ
app.get('/', (req, res) => {
    res.json({
        success: true,
        message: 'SEU Matrimony Backend is Live! ðŸš€',
        timestamp: new Date().toISOString(),
        endpoints: {
            'POST /register-user': 'User registration',
            'PATCH /verify-email': 'Email verification',
            'GET /user/:email': 'Get user info',
            'PUT /biodata': 'Save/Update biodata',
            'GET /all-biodata': 'Get approved biodatas',
            'POST /send-request': 'Send connection request',
            'GET /admin-stats': 'Admin statistics'
        }
    });
});

// à¦¸à¦¾à¦°à§à¦­à¦¾à¦° à¦²à¦¿à¦¸à§‡à¦¨à¦¿à¦‚
app.listen(port, () => {
    console.log(` âš¡ Nodemon: Server running on port ${port}`);
});